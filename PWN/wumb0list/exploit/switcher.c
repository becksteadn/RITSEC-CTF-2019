#include <fcntl.h>
#include <unistd.h>
#include <sys/mman.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

unsigned char *get_file_contents(char *filename, size_t *sz)
{
    //printf("Opening %s\n", filename);
    FILE* f = fopen(filename, "r");
    fseek(f, 0, SEEK_END);
    *sz = (size_t)ftell(f);
    //printf("File size: %lu\n", *sz);
    fseek(f, 0, SEEK_SET);
    unsigned char *buf = calloc(1, *sz);
    fread(buf, *sz, 1, f);
    return buf;
}

int main(int argc, char **argv){
    unsigned char *fc1, *fc2;
    size_t l1, l2;
    if (argc < 4)
        return 1;

    unsigned long st1 = strtol(argv[2], NULL, 10);
    unsigned long st2 = strtol(argv[3], NULL, 10);

    int fd = open(argv[1], O_RDWR);
    if (fd < 0){
        puts("No file by that name can be opened");
        return 1;
    }

    int mapsize = lseek(fd, 0, SEEK_END);
    if (mapsize == -1){
        puts("Invalid file");
        return 1;
    }
    void *mem = mmap(NULL, mapsize, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);
    if (mem == MAP_FAILED){
        puts("Mapping failed");
        close(fd);
        return 1;
    }

    char *f1 = malloc(strlen(argv[1]) + 2);
    strcpy(f1, argv[1]);
    strcat(f1, "1");
    char *f2 = malloc(strlen(argv[1]) + 2);
    strcpy(f2, argv[1]);
    strcat(f2, "2");

    fc1 = get_file_contents(f1, &l1);
    fc2 = get_file_contents(f2, &l2);

    while (1){
        memcpy(mem, fc1, l1);
        usleep(st1);
        memcpy(mem, fc2, l2);
        usleep(st2);
    }

    munmap(mem, mapsize);
    close(fd);
    return 0;
}
